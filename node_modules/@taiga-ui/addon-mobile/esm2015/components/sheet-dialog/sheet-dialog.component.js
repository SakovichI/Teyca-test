import { __decorate } from "tslib";
import { ChangeDetectionStrategy, Component, ElementRef, HostBinding, HostListener, Inject, ViewChild, ViewChildren, } from '@angular/core';
import { EMPTY_QUERY, tuiPure } from '@taiga-ui/cdk';
import { TUI_ANIMATIONS_DURATION, TUI_CLOSE_WORD, TUI_COMMON_ICONS, tuiSlideInTop, } from '@taiga-ui/core';
import { shouldCall } from '@tinkoff/ng-event-plugins';
import { POLYMORPHEUS_CONTEXT } from '@tinkoff/ng-polymorpheus';
import { BehaviorSubject } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
import * as i2 from "@taiga-ui/cdk";
import * as i3 from "./sheet-dialog-close.directive";
import * as i4 from "@tinkoff/ng-polymorpheus";
import * as i5 from "rxjs";
// So we re-enter ngZone and trigger change detection
function isCloseable() {
    return this.context.closeable;
}
export class TuiSheetDialogComponent {
    constructor(el, duration, icons, closeWord$, context) {
        this.el = el;
        this.duration = duration;
        this.icons = icons;
        this.closeWord$ = closeWord$;
        this.context = context;
        this.stopsRefs = EMPTY_QUERY;
        this.pointers = 0;
        this.slideInTop = {
            value: '',
            params: {
                start: '100vh',
                duration: this.duration,
            },
        };
        this.stuck$ = new BehaviorSubject(false);
    }
    get closeable() {
        return this.context.closeable;
    }
    get isSmall() {
        var _a;
        return this.sheetTop > (((_a = this.sheet) === null || _a === void 0 ? void 0 : _a.nativeElement.clientHeight) || Infinity);
    }
    onPointerChange(delta) {
        this.pointers = Math.max(this.pointers + delta, 0);
        if (!delta) {
            const stuck = this.el.nativeElement.scrollTop > this.sheetTop;
            this.stuck$.value !== stuck && this.stuck$.next(stuck);
        }
        if (this.context.closeable &&
            !this.pointers &&
            this.el.nativeElement.scrollTop <= 0) {
            this.close();
        }
    }
    close() {
        // TODO: Refactor focus visible on mobile
        this.el.nativeElement.dispatchEvent(new Event('mousedown', { bubbles: true }));
        this.context.$implicit.complete();
    }
    ngAfterViewInit() {
        this.el.nativeElement.scrollTop = [
            ...this.getStops(this.stopsRefs),
            this.sheetTop,
        ][this.context.initial];
    }
    get sheetTop() {
        var _a, _b;
        return (_b = (_a = this.sheet) === null || _a === void 0 ? void 0 : _a.nativeElement.offsetTop) !== null && _b !== void 0 ? _b : Infinity;
    }
    getStops(stops) {
        return stops.map(({ nativeElement }) => nativeElement.offsetTop + nativeElement.clientHeight);
    }
}
TuiSheetDialogComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: TuiSheetDialogComponent, deps: [{ token: ElementRef }, { token: TUI_ANIMATIONS_DURATION }, { token: TUI_COMMON_ICONS }, { token: TUI_CLOSE_WORD }, { token: POLYMORPHEUS_CONTEXT }], target: i0.ɵɵFactoryTarget.Component });
TuiSheetDialogComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.17", type: TuiSheetDialogComponent, selector: "tui-sheet-dialog", host: { listeners: { "$.class._stuck": "stuck$", "document:touchstart.passive.silent": "onPointerChange(1)", "document:touchend.silent": "onPointerChange(-1)", "document:touchcancel.silent": "onPointerChange(-1)", "scroll.silent": "onPointerChange(0)" }, properties: { "$.class._stuck": "stuck$", "style.--tui-offset.px": "context.offset", "class._fullscreen": "context.fullscreen === true", "attr.data-appearance": "context.appearance", "@tuiSlideInTop": "this.slideInTop", "class._closeable": "this.closeable" } }, viewQueries: [{ propertyName: "sheet", first: true, predicate: ["sheet"], descendants: true }, { propertyName: "stopsRefs", predicate: ["stops"], descendants: true }], ngImport: i0, template: "<div class=\"t-stops\">\n    <div\n        *ngFor=\"let stop of context.stops\"\n        #stops\n        class=\"t-stop\"\n        [style.margin-top]=\"stop\"\n    ></div>\n</div>\n<div\n    #sheet\n    class=\"t-sheet\"\n    [class.t-sheet_small]=\"isSmall\"\n    (tuiClickOutside)=\"close()\"\n    (tuiSheetDialogClose)=\"close()\"\n>\n    <div\n        *ngIf=\"context.bar\"\n        class=\"t-top\"\n    ></div>\n    <h2\n        *ngIf=\"context.label\"\n        class=\"t-heading\"\n        [id]=\"context.id\"\n    >\n        <ng-container *polymorpheusOutlet=\"context.label as label; context: context\">\n            {{ label }}\n        </ng-container>\n    </h2>\n    <div\n        *ngIf=\"context.content\"\n        class=\"t-content\"\n    >\n        <ng-container *polymorpheusOutlet=\"context.content as text; context: context\">\n            {{ text }}\n        </ng-container>\n    </div>\n</div>\n<div class=\"t-footer\"></div>\n", styles: [":host{position:fixed;top:0;left:0;bottom:0;right:0;right:-1rem;top:calc(var(--tui-offset) + env(safe-area-inset-top));display:flex;flex-direction:column;-webkit-clip-path:inset(0 1rem 0 0 round .75rem .75rem 0 0);clip-path:inset(0 1rem 0 0 round .75rem .75rem 0 0);block-size:calc(100% - var(--tui-offset) - env(safe-area-inset-top));font:var(--tui-font-text-m);overflow-y:scroll;scroll-snap-type:y mandatory;overscroll-behavior:none;box-shadow:0 20rem var(--tui-elevation-01)}:host._closeable{display:block}:host._closeable .t-stops{display:flex}:host._fullscreen{display:block}:host._fullscreen .t-sheet{display:flex;flex-direction:column;min-block-size:calc(100% - 1rem - env(safe-area-inset-bottom))}:host._fullscreen .t-content{display:flex;flex-direction:column;flex-grow:1}.t-stops{display:none;height:100%;scroll-snap-stop:always;scroll-snap-align:start}.t-stop{top:env(safe-area-inset-bottom);scroll-snap-stop:normal;scroll-snap-align:start;height:1rem;width:1rem}.t-sheet{box-shadow:var(--tui-shadow);width:calc(100% - 1rem);border-radius:.75rem .75rem 0 0;padding:0 1rem;margin-top:auto;background:var(--tui-elevation-01);box-sizing:border-box;scroll-snap-stop:always;scroll-snap-align:start}@supports (-moz-appearance: none){.t-sheet_small{scroll-snap-align:end}}.t-top{position:-webkit-sticky;position:sticky;top:0;z-index:1;height:1.5rem;background:var(--tui-elevation-01)}.t-top:after{content:\"\";position:absolute;top:.5rem;left:50%;width:2rem;height:.25rem;transform:translate(-50%);background:var(--tui-base-09);opacity:.3;border-radius:1rem}.t-heading{position:-webkit-sticky;position:sticky;top:1.5rem;z-index:1;display:flex;margin:0;padding-bottom:1rem;font:var(--tui-font-heading-6);background:var(--tui-elevation-01)}.t-heading:last-child{margin-bottom:-.75rem}.t-heading:after{content:\"\";position:absolute;top:100%;left:0;right:0;height:1px;background:var(--tui-base-03);opacity:0}:host._stuck .t-heading:after{opacity:1}.t-close{right:-.25rem;flex-shrink:0;margin-left:auto}.t-content{position:relative;isolation:isolate;border-radius:inherit}.t-content:nth-child(3){margin-top:1rem}.t-footer{height:calc(1rem + env(safe-area-inset-bottom));scroll-snap-stop:always;scroll-snap-align:end;background:var(--tui-elevation-01)}\n"], directives: [{ type: i1.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { type: i2.TuiClickOutsideDirective, selector: "[tuiClickOutside]", outputs: ["tuiClickOutside"] }, { type: i3.TuiSheetDialogCloseDirective, selector: "[tuiSheetDialogClose]", outputs: ["tuiSheetDialogClose"] }, { type: i1.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { type: i4.PolymorpheusOutletDirective, selector: "[polymorpheusOutlet]", inputs: ["polymorpheusOutlet", "polymorpheusOutletContext"] }], animations: [tuiSlideInTop], changeDetection: i0.ChangeDetectionStrategy.OnPush });
__decorate([
    shouldCall(isCloseable)
], TuiSheetDialogComponent.prototype, "close", null);
__decorate([
    tuiPure
], TuiSheetDialogComponent.prototype, "getStops", null);
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: TuiSheetDialogComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'tui-sheet-dialog',
                    templateUrl: './sheet-dialog.template.html',
                    styleUrls: ['./sheet-dialog.style.less'],
                    changeDetection: ChangeDetectionStrategy.OnPush,
                    animations: [tuiSlideInTop],
                    host: {
                        '[$.class._stuck]': 'stuck$',
                        '($.class._stuck)': 'stuck$',
                        '[style.--tui-offset.px]': 'context.offset',
                        '[class._fullscreen]': 'context.fullscreen === true',
                        '[attr.data-appearance]': 'context.appearance',
                    },
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef, decorators: [{
                    type: Inject,
                    args: [ElementRef]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [TUI_ANIMATIONS_DURATION]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [TUI_COMMON_ICONS]
                }] }, { type: i5.Observable, decorators: [{
                    type: Inject,
                    args: [TUI_CLOSE_WORD]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [POLYMORPHEUS_CONTEXT]
                }] }]; }, propDecorators: { sheet: [{
                type: ViewChild,
                args: ['sheet']
            }], stopsRefs: [{
                type: ViewChildren,
                args: ['stops']
            }], slideInTop: [{
                type: HostBinding,
                args: ['@tuiSlideInTop']
            }], closeable: [{
                type: HostBinding,
                args: ['class._closeable']
            }], onPointerChange: [{
                type: HostListener,
                args: ['document:touchstart.passive.silent', ['1']]
            }, {
                type: HostListener,
                args: ['document:touchend.silent', ['-1']]
            }, {
                type: HostListener,
                args: ['document:touchcancel.silent', ['-1']]
            }, {
                type: HostListener,
                args: ['scroll.silent', ['0']]
            }], close: [], getStops: [] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hlZXQtZGlhbG9nLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2FkZG9uLW1vYmlsZS9jb21wb25lbnRzL3NoZWV0LWRpYWxvZy9zaGVldC1kaWFsb2cuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYWRkb24tbW9iaWxlL2NvbXBvbmVudHMvc2hlZXQtZGlhbG9nL3NoZWV0LWRpYWxvZy50ZW1wbGF0ZS5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBRUgsdUJBQXVCLEVBQ3ZCLFNBQVMsRUFDVCxVQUFVLEVBQ1YsV0FBVyxFQUNYLFlBQVksRUFDWixNQUFNLEVBRU4sU0FBUyxFQUNULFlBQVksR0FDZixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUMsV0FBVyxFQUFhLE9BQU8sRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUM5RCxPQUFPLEVBQ0gsdUJBQXVCLEVBQ3ZCLGNBQWMsRUFDZCxnQkFBZ0IsRUFFaEIsYUFBYSxHQUNoQixNQUFNLGdCQUFnQixDQUFDO0FBQ3hCLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSwyQkFBMkIsQ0FBQztBQUNyRCxPQUFPLEVBQUMsb0JBQW9CLEVBQUMsTUFBTSwwQkFBMEIsQ0FBQztBQUM5RCxPQUFPLEVBQUMsZUFBZSxFQUFhLE1BQU0sTUFBTSxDQUFDOzs7Ozs7O0FBSWpELHFEQUFxRDtBQUNyRCxTQUFTLFdBQVc7SUFDaEIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQztBQUNsQyxDQUFDO0FBZ0JELE1BQU0sT0FBTyx1QkFBdUI7SUFvQmhDLFlBQ3lDLEVBQTJCLEVBQ2QsUUFBZ0IsRUFDL0IsS0FBcUIsRUFDdkIsVUFBOEIsRUFFdEQsT0FBaUQ7UUFMckIsT0FBRSxHQUFGLEVBQUUsQ0FBeUI7UUFDZCxhQUFRLEdBQVIsUUFBUSxDQUFRO1FBQy9CLFVBQUssR0FBTCxLQUFL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bUJBQUM7b0JBQ1AsUUFBUSxFQUFFLGtCQUFrQjtvQkFDNUIsV0FBVyxFQUFFLDhCQUE4QjtvQkFDM0MsU0FBUyxFQUFFLENBQUMsMkJBQTJCLENBQUM7b0JBQ3hDLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNO29CQUMvQyxVQUFVLEVBQUUsQ0FBQyxhQUFhLENBQUM7b0JBQzNCLElBQUksRUFBRTt3QkFDRixrQkFBa0IsRUFBRSxRQUFRO3dCQUM1QixrQkFBa0IsRUFBRSxRQUFRO3dCQUM1Qix5QkFBeUIsRUFBRSxnQkFBZ0I7d0JBQzNDLHFCQUFxQixFQUFFLDZCQUE2Qjt3QkFDcEQsd0JBQXdCLEVBQUUsb0JBQW9CO3FCQUNqRDtpQkFDSjs7MEJBc0JRLE1BQU07MkJBQUMsVUFBVTs7MEJBQ2pCLE1BQU07MkJBQUMsdUJBQXVCOzswQkFDOUIsTUFBTTsyQkFBQyxnQkFBZ0I7OzBCQUN2QixNQUFNOzJCQUFDLGNBQWM7OzBCQUNyQixNQUFNOzJCQUFDLG9CQUFvQjs0Q0F2QmYsS0FBSztzQkFEckIsU0FBUzt1QkFBQyxPQUFPO2dCQUlELFNBQVM7c0JBRHpCLFlBQVk7dUJBQUMsT0FBTztnQkFNWixVQUFVO3NCQURsQixXQUFXO3VCQUFDLGdCQUFnQjtnQkFxQnpCLFNBQVM7c0JBRFosV0FBVzt1QkFBQyxrQkFBa0I7Z0JBYS9CLGVBQWU7c0JBSmQsWUFBWTt1QkFBQyxvQ0FBb0MsRUFBRSxDQUFDLEdBQUcsQ0FBQzs7c0JBQ3hELFlBQVk7dUJBQUMsMEJBQTBCLEVBQUUsQ0FBQyxJQUFJLENBQUM7O3NCQUMvQyxZQUFZO3VCQUFDLDZCQUE2QixFQUFFLENBQUMsSUFBSSxDQUFDOztzQkFDbEQsWUFBWTt1QkFBQyxlQUFlLEVBQUUsQ0FBQyxHQUFHLENBQUM7Z0JBb0JwQyxLQUFLLE1Ba0JHLFFBQVEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICAgIEFmdGVyVmlld0luaXQsXG4gICAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksXG4gICAgQ29tcG9uZW50LFxuICAgIEVsZW1lbnRSZWYsXG4gICAgSG9zdEJpbmRpbmcsXG4gICAgSG9zdExpc3RlbmVyLFxuICAgIEluamVjdCxcbiAgICBRdWVyeUxpc3QsXG4gICAgVmlld0NoaWxkLFxuICAgIFZpZXdDaGlsZHJlbixcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0VNUFRZX1FVRVJZLCBUdWlEaWFsb2csIHR1aVB1cmV9IGZyb20gJ0B0YWlnYS11aS9jZGsnO1xuaW1wb3J0IHtcbiAgICBUVUlfQU5JTUFUSU9OU19EVVJBVElPTixcbiAgICBUVUlfQ0xPU0VfV09SRCxcbiAgICBUVUlfQ09NTU9OX0lDT05TLFxuICAgIFR1aUNvbW1vbkljb25zLFxuICAgIHR1aVNsaWRlSW5Ub3AsXG59IGZyb20gJ0B0YWlnYS11aS9jb3JlJztcbmltcG9ydCB7c2hvdWxkQ2FsbH0gZnJvbSAnQHRpbmtvZmYvbmctZXZlbnQtcGx1Z2lucyc7XG5pbXBvcnQge1BPTFlNT1JQSEVVU19DT05URVhUfSBmcm9tICdAdGlua29mZi9uZy1wb2x5bW9ycGhldXMnO1xuaW1wb3J0IHtCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGV9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQge1R1aVNoZWV0RGlhbG9nT3B0aW9uc30gZnJvbSAnLi9zaGVldC1kaWFsb2cub3B0aW9ucyc7XG5cbi8vIFNvIHdlIHJlLWVudGVyIG5nWm9uZSBhbmQgdHJpZ2dlciBjaGFuZ2UgZGV0ZWN0aW9uXG5mdW5jdGlvbiBpc0Nsb3NlYWJsZSh0aGlzOiBUdWlTaGVldERpYWxvZ0NvbXBvbmVudDx1bmtub3duPik6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmNvbnRleHQuY2xvc2VhYmxlO1xufVxuXG5AQ29tcG9uZW50KHtcbiAgICBzZWxlY3RvcjogJ3R1aS1zaGVldC1kaWFsb2cnLFxuICAgIHRlbXBsYXRlVXJsOiAnLi9zaGVldC1kaWFsb2cudGVtcGxhdGUuaHRtbCcsXG4gICAgc3R5bGVVcmxzOiBbJy4vc2hlZXQtZGlhbG9nLnN0eWxlLmxlc3MnXSxcbiAgICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbiAgICBhbmltYXRpb25zOiBbdHVpU2xpZGVJblRvcF0sXG4gICAgaG9zdDoge1xuICAgICAgICAnWyQuY2xhc3MuX3N0dWNrXSc6ICdzdHVjayQnLFxuICAgICAgICAnKCQuY2xhc3MuX3N0dWNrKSc6ICdzdHVjayQnLFxuICAgICAgICAnW3N0eWxlLi0tdHVpLW9mZnNldC5weF0nOiAnY29udGV4dC5vZmZzZXQnLFxuICAgICAgICAnW2NsYXNzLl9mdWxsc2NyZWVuXSc6ICdjb250ZXh0LmZ1bGxzY3JlZW4gPT09IHRydWUnLFxuICAgICAgICAnW2F0dHIuZGF0YS1hcHBlYXJhbmNlXSc6ICdjb250ZXh0LmFwcGVhcmFuY2UnLFxuICAgIH0sXG59KVxuZXhwb3J0IGNsYXNzIFR1aVNoZWV0RGlhbG9nQ29tcG9uZW50PEk+IGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCB7XG4gICAgQFZpZXdDaGlsZCgnc2hlZXQnKVxuICAgIHByaXZhdGUgcmVhZG9ubHkgc2hlZXQ/OiBFbGVtZW50UmVmPEhUTUxFbGVtZW50PjtcblxuICAgIEBWaWV3Q2hpbGRyZW4oJ3N0b3BzJylcbiAgICBwcml2YXRlIHJlYWRvbmx5IHN0b3BzUmVmczogUXVlcnlMaXN0PEVsZW1lbnRSZWY8SFRNTEVsZW1lbnQ+PiA9IEVNUFRZX1FVRVJZO1xuXG4gICAgcHJpdmF0ZSBwb2ludGVycyA9IDA7XG5cbiAgICBASG9zdEJpbmRpbmcoJ0B0dWlTbGlkZUluVG9wJylcbiAgICByZWFkb25seSBzbGlkZUluVG9wID0ge1xuICAgICAgICB2YWx1ZTogJycsXG4gICAgICAgIHBhcmFtczoge1xuICAgICAgICAgICAgc3RhcnQ6ICcxMDB2aCcsXG4gICAgICAgICAgICBkdXJhdGlvbjogdGhpcy5kdXJhdGlvbixcbiAgICAgICAgfSxcbiAgICB9O1xuXG4gICAgc3R1Y2skID0gbmV3IEJlaGF2aW9yU3ViamVjdChmYWxzZSk7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgQEluamVjdChFbGVtZW50UmVmKSBwcml2YXRlIHJlYWRvbmx5IGVsOiBFbGVtZW50UmVmPEhUTUxFbGVtZW50PixcbiAgICAgICAgQEluamVjdChUVUlfQU5JTUFUSU9OU19EVVJBVElPTikgcHJpdmF0ZSByZWFkb25seSBkdXJhdGlvbjogbnVtYmVyLFxuICAgICAgICBASW5qZWN0KFRVSV9DT01NT05fSUNPTlMpIHJlYWRvbmx5IGljb25zOiBUdWlDb21tb25JY29ucyxcbiAgICAgICAgQEluamVjdChUVUlfQ0xPU0VfV09SRCkgcmVhZG9ubHkgY2xvc2VXb3JkJDogT2JzZXJ2YWJsZTxzdHJpbmc+LFxuICAgICAgICBASW5qZWN0KFBPTFlNT1JQSEVVU19DT05URVhUKVxuICAgICAgICByZWFkb25seSBjb250ZXh0OiBUdWlEaWFsb2c8VHVpU2hlZXREaWFsb2dPcHRpb25zPEk+LCBhbnk+LFxuICAgICkge31cblxuICAgIEBIb3N0QmluZGluZygnY2xhc3MuX2Nsb3NlYWJsZScpXG4gICAgZ2V0IGNsb3NlYWJsZSgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY29udGV4dC5jbG9zZWFibGU7XG4gICAgfVxuXG4gICAgZ2V0IGlzU21hbGwoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLnNoZWV0VG9wID4gKHRoaXMuc2hlZXQ/Lm5hdGl2ZUVsZW1lbnQuY2xpZW50SGVpZ2h0IHx8IEluZmluaXR5KTtcbiAgICB9XG5cbiAgICBASG9zdExpc3RlbmVyKCdkb2N1bWVudDp0b3VjaHN0YXJ0LnBhc3NpdmUuc2lsZW50JywgWycxJ10pXG4gICAgQEhvc3RMaXN0ZW5lcignZG9jdW1lbnQ6dG91Y2hlbmQuc2lsZW50JywgWyctMSddKVxuICAgIEBIb3N0TGlzdGVuZXIoJ2RvY3VtZW50OnRvdWNoY2FuY2VsLnNpbGVudCcsIFsnLTEnXSlcbiAgICBASG9zdExpc3RlbmVyKCdzY3JvbGwuc2lsZW50JywgWycwJ10pXG4gICAgb25Qb2ludGVyQ2hhbmdlKGRlbHRhOiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5wb2ludGVycyA9IE1hdGgubWF4KHRoaXMucG9pbnRlcnMgKyBkZWx0YSwgMCk7XG5cbiAgICAgICAgaWYgKCFkZWx0YSkge1xuICAgICAgICAgICAgY29uc3Qgc3R1Y2sgPSB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuc2Nyb2xsVG9wID4gdGhpcy5zaGVldFRvcDtcblxuICAgICAgICAgICAgdGhpcy5zdHVjayQudmFsdWUgIT09IHN0dWNrICYmIHRoaXMuc3R1Y2skLm5leHQoc3R1Y2spO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgdGhpcy5jb250ZXh0LmNsb3NlYWJsZSAmJlxuICAgICAgICAgICAgIXRoaXMucG9pbnRlcnMgJiZcbiAgICAgICAgICAgIHRoaXMuZWwubmF0aXZlRWxlbWVudC5zY3JvbGxUb3AgPD0gMFxuICAgICAgICApIHtcbiAgICAgICAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIEBzaG91bGRDYWxsKGlzQ2xvc2VhYmxlKVxuICAgIGNsb3NlKCk6IHZvaWQge1xuICAgICAgICAvLyBUT0RPOiBSZWZhY3RvciBmb2N1cyB2aXNpYmxlIG9uIG1vYmlsZVxuICAgICAgICB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuZGlzcGF0Y2hFdmVudChuZXcgRXZlbnQoJ21vdXNlZG93bicsIHtidWJibGVzOiB0cnVlfSkpO1xuICAgICAgICB0aGlzLmNvbnRleHQuJGltcGxpY2l0LmNvbXBsZXRlKCk7XG4gICAgfVxuXG4gICAgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xuICAgICAgICB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuc2Nyb2xsVG9wID0gW1xuICAgICAgICAgICAgLi4udGhpcy5nZXRTdG9wcyh0aGlzLnN0b3BzUmVmcyksXG4gICAgICAgICAgICB0aGlzLnNoZWV0VG9wLFxuICAgICAgICBdW3RoaXMuY29udGV4dC5pbml0aWFsXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldCBzaGVldFRvcCgpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5zaGVldD8ubmF0aXZlRWxlbWVudC5vZmZzZXRUb3AgPz8gSW5maW5pdHk7XG4gICAgfVxuXG4gICAgQHR1aVB1cmVcbiAgICBwcml2YXRlIGdldFN0b3BzKHN0b3BzOiBRdWVyeUxpc3Q8RWxlbWVudFJlZjxIVE1MRWxlbWVudD4+KTogcmVhZG9ubHkgbnVtYmVyW10ge1xuICAgICAgICByZXR1cm4gc3RvcHMubWFwKFxuICAgICAgICAgICAgKHtuYXRpdmVFbGVtZW50fSkgPT4gbmF0aXZlRWxlbWVudC5vZmZzZXRUb3AgKyBuYXRpdmVFbGVtZW50LmNsaWVudEhlaWdodCxcbiAgICAgICAgKTtcbiAgICB9XG59XG4iLCI8ZGl2IGNsYXNzPVwidC1zdG9wc1wiPlxuICAgIDxkaXZcbiAgICAgICAgKm5nRm9yPVwibGV0IHN0b3Agb2YgY29udGV4dC5zdG9wc1wiXG4gICAgICAgICNzdG9wc1xuICAgICAgICBjbGFzcz1cInQtc3RvcFwiXG4gICAgICAgIFtzdHlsZS5tYXJnaW4tdG9wXT1cInN0b3BcIlxuICAgID48L2Rpdj5cbjwvZGl2PlxuPGRpdlxuICAgICNzaGVldFxuICAgIGNsYXNzPVwidC1zaGVldFwiXG4gICAgW2NsYXNzLnQtc2hlZXRfc21hbGxdPVwiaXNTbWFsbFwiXG4gICAgKHR1aUNsaWNrT3V0c2lkZSk9XCJjbG9zZSgpXCJcbiAgICAodHVpU2hlZXREaWFsb2dDbG9zZSk9XCJjbG9zZSgpXCJcbj5cbiAgICA8ZGl2XG4gICAgICAgICpuZ0lmPVwiY29udGV4dC5iYXJcIlxuICAgICAgICBjbGFzcz1cInQtdG9wXCJcbiAgICA+PC9kaXY+XG4gICAgPGgyXG4gICAgICAgICpuZ0lmPVwiY29udGV4dC5sYWJlbFwiXG4gICAgICAgIGNsYXNzPVwidC1oZWFkaW5nXCJcbiAgICAgICAgW2lkXT1cImNvbnRleHQuaWRcIlxuICAgID5cbiAgICAgICAgPG5nLWNvbnRhaW5lciAqcG9seW1vcnBoZXVzT3V0bGV0PVwiY29udGV4dC5sYWJlbCBhcyBsYWJlbDsgY29udGV4dDogY29udGV4dFwiPlxuICAgICAgICAgICAge3sgbGFiZWwgfX1cbiAgICAgICAgPC9uZy1jb250YWluZXI+XG4gICAgPC9oMj5cbiAgICA8ZGl2XG4gICAgICAgICpuZ0lmPVwiY29udGV4dC5jb250ZW50XCJcbiAgICAgICAgY2xhc3M9XCJ0LWNvbnRlbnRcIlxuICAgID5cbiAgICAgICAgPG5nLWNvbnRhaW5lciAqcG9seW1vcnBoZXVzT3V0bGV0PVwiY29udGV4dC5jb250ZW50IGFzIHRleHQ7IGNvbnRleHQ6IGNvbnRleHRcIj5cbiAgICAgICAgICAgIHt7IHRleHQgfX1cbiAgICAgICAgPC9uZy1jb250YWluZXI+XG4gICAgPC9kaXY+XG48L2Rpdj5cbjxkaXYgY2xhc3M9XCJ0LWZvb3RlclwiPjwvZGl2PlxuIl19